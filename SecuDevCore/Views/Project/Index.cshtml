@using SecuDev.Models;
@using SecuDev.Helper;
@using X.PagedList.Mvc;
@using X.PagedList.Mvc.Core;
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    string nowDate = Utility.GetNowDate();

    string tree = ViewBag.tree;

    HttpContextAccessor _Ac = new HttpContextAccessor();
    int AuthorityLevel = Int32.Parse(_Ac.HttpContext.Session.GetString("AuthorityLevel"));
    string UID = _Ac.HttpContext.Session.GetString("UID");

}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>

<script>

    $().ready(function(){

        var jstree =
        $("#tree").jstree({
            'core' : {'data' : getData()},
            'plugins': ['search', 'types'],
            'types': {
                'default' : {
                    'icon' : false
                }
            }
        })
        .on('ready.jstree', function (e, data) {
            data.instance.close_all()
            data.instance.deselect_all()
        });

        jstree.bind("dblclick.jstree", function (evt) {
            var tree = $(this).jstree(); 			
            var node = tree.get_node(evt.target); 			
            
            if (node.children.length == 0) {

                fnOpenModal(node.id)

            }

        });

        var target = false;

        $('#search-node').keyup(function () {
            if(target) { clearTimeout(target); }
                to = setTimeout(function () {
                var v = $('#search-node').val();
                $('#tree').jstree(true).search(v);
            }, 250);
        });

    })

    function getData() {

        var data = @Html.Raw(tree)

        return data;
    }

    function changeIframeUrl(url)
    {
        document.getElementById("IfProject").src = url;
    }

    function fnOpenModal(LocationID) {

        $("#IfProject").attr("src", "/Project/IfRead?LocationID=" + LocationID);

        $("#proj").modal('show')
    }

    function fnAddNode() {

        var newNode = {'text':'New Node'}

        $('#tree').jstree('create_node', '#', newNode, 'last');

    }
</script>

<div>

    <div class="card">
        <div class="card-body">

            <div id="search-area" class="d-flex mb-3">
                <div class="input-group input-group-sm flex-grow-1">
                    <input id="search-node" type="text" class="form-control form-control-sm" placeholder="검색어 입력" ent="fnSearch()" />
                </div>
            </div>

            <div>
                <button type="button" onclick="fnAddNode()" class="btn btn-sm btn-border me-1 ms-auto mb-2">
                    <i class="fa-solid fa-plus me-1 text-success"></i>
                    추가
                </button>
            </div>

            <hr />

            <div id="tree" class="pb-3"></div>
        </div>
    </div>

</div>

<div id="proj" class="modal fade">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h6>프로젝트 이름</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

                @* <div>
                    <h6>
                        프로젝트 진행률
                        <small class="float-end">프로젝트 진행중...</small>
                    </h6>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-dark" style="width:70%">70%</div>
                    </div>
                </div>

                <hr /> *@

                <iframe id="IfProject">

                </iframe>

            </div>
        </div>
    </div>
</div>